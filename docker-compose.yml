version: "3.9"

# Immutable Audit Layer - Production-equivalent Docker stack
#
# Services:
#   postgres      - Operational event store (events, batches, anchors)
#   besu          - Hyperledger Besu permissioned EVM (IBFT2, dev mode)
#   audit-gateway - FastAPI: ingest, batch, anchor, verify
#   iot-sim       - IoT event generator (runs scenarios)
#   verifier      - Standalone integrity verifier
#
# Quick start:
#   make up        - start everything (gateway waits for Postgres + Besu)
#   make seed      - generate 200 normal events
#   make verify    - verify all anchored batches
#   make results   - run all experiments -> results/*.csv

networks:
  audit-net:
    name: audit-net
    driver: bridge

volumes:
  postgres-data:
    name: audit-postgres-data
  besu-data:
    name: audit-besu-data

services:

  #  PostgreSQL (operational store) 
  postgres:
    image: postgres:16-alpine
    container_name: audit-postgres
    environment:
      POSTGRES_USER:     audit
      POSTGRES_PASSWORD: audit
      POSTGRES_DB:       auditdb
    volumes:
      - postgres-data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - audit-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U audit -d auditdb"]
      interval: 5s
      timeout: 3s
      retries: 10

  #  Hyperledger Besu (permissioned EVM, dev/single-node) 
  # Dev mode: no mining delay, gas price 0, pre-funded accounts
  # In a production deployment, replace with a 4-node QBFT network.
  besu:
    image: hyperledger/besu:24.9
    container_name: audit-besu
    command:
      - "--network=dev"
      - "--rpc-http-enabled"
      - "--rpc-http-host=0.0.0.0"
      - "--rpc-http-port=8545"
      - "--rpc-http-cors-origins=*"
      - "--rpc-http-api=ETH,NET,WEB3,MINER,ADMIN"
      - "--rpc-ws-enabled"
      - "--rpc-ws-host=0.0.0.0"
      - "--rpc-ws-port=8546"
      - "--host-allowlist=*"
      - "--miner-enabled"
      - "--miner-coinbase=0xfe3b557e8fb62b89f4916b721be55ceb828dbd73"
      - "--min-gas-price=0"
      - "--data-path=/var/lib/besu"
      - "--logging=WARN"
    volumes:
      - besu-data:/var/lib/besu
    ports:
      - "8545:8545"
      - "8546:8546"
    networks:
      - audit-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -sf -X POST http://localhost:8545 -H 'Content-Type: application/json' -d '{\"jsonrpc\":\"2.0\",\"method\":\"net_version\",\"params\":[],\"id\":1}' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10

  #  Contract deployer (runs once, exits) 
  contract-deployer:
    build:
      context: ./services/audit-gateway
      dockerfile: Dockerfile
    container_name: audit-contract-deployer
    environment:
      BESU_RPC:           "http://besu:8545"
      GATEWAY_PRIVATE_KEY: "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80"
    command: ["python", "/app/contracts/deploy.py"]
    volumes:
      - ./contracts:/app/contracts
    depends_on:
      besu:
        condition: service_healthy
    networks:
      - audit-net
    restart: "no"

  #  Audit Gateway (main application) 
  audit-gateway:
    build:
      context: ./services/audit-gateway
      dockerfile: Dockerfile
    container_name: audit-gateway
    environment:
      DATABASE_URL:        "postgresql://audit:audit@postgres:5432/auditdb"
      BESU_RPC:            "http://besu:8545"
      LEDGER_BACKEND:      "${LEDGER_BACKEND:-besu}"
      GATEWAY_PRIVATE_KEY: "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80"
      BATCH_WINDOW_SECONDS: "${BATCH_WINDOW_SECONDS:-5}"
      MIN_BATCH_SIZE:      "1"
      LOG_LEVEL:           "INFO"
    volumes:
      - ./contracts:/app/contracts:ro
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy
      besu:
        condition: service_healthy
    networks:
      - audit-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 10

  #  IoT Simulator (runs scenarios on demand) 
  iot-sim:
    build:
      context: ./services/iot-sim
      dockerfile: Dockerfile
    container_name: audit-iot-sim
    environment:
      GATEWAY_URL: "http://audit-gateway:8000"
    depends_on:
      audit-gateway:
        condition: service_healthy
    networks:
      - audit-net
    profiles:
      - sim
    restart: "no"

  #  Verifier (runs on demand) 
  verifier:
    build:
      context: ./services/verifier
      dockerfile: Dockerfile
    container_name: audit-verifier
    environment:
      GATEWAY_URL: "http://audit-gateway:8000"
    volumes:
      - ./results:/app/results
    depends_on:
      audit-gateway:
        condition: service_healthy
    networks:
      - audit-net
    profiles:
      - verify
    restart: "no"
