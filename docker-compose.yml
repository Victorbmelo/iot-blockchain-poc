version: "3.9"

# Application stack: gateway + MinIO.
# For the full Fabric network see fabric/network/docker-compose-fabric.yml.
#
# Modes:
#   Stub (default):  FABRIC_STUB_MODE=true  - in-memory ledger, no Fabric required
#   Fabric:          FABRIC_STUB_MODE=false  - connects to fabric/network/ containers
#
# Quick start (stub mode):
#   docker compose up --build
#
# Full Fabric mode (start Fabric first):
#   bash fabric/network/network.sh up
#   bash fabric/network/network.sh deploy
#   FABRIC_STUB_MODE=false docker compose up --build

networks:
  audit_app:
    name: audit_app
    driver: bridge
  audit_fabric:
    name: audit_fabric
    external: true

volumes:
  minio-data:
    name: audit-minio-data

services:

  audit-gateway:
    build:
      context: ./gateway
      dockerfile: Dockerfile
    container_name: audit-gateway
    ports:
      - "8080:8080"
    environment:
      FABRIC_STUB_MODE: "${FABRIC_STUB_MODE:-true}"
      LOG_LEVEL: "INFO"
      RESULTS_DIR: "/results"
      GATEWAY_SIGNER_ID: "audit-gateway-01"
      # Fabric connection (used when FABRIC_STUB_MODE=false):
      FABRIC_PEER_ENDPOINT: "peer0.org1.audit.local:7051"
      FABRIC_CHANNEL: "audit-channel"
      FABRIC_CHAINCODE: "auditcc"
      FABRIC_PEER_TLS_CERT: "/certs/peer0-org1-tls-ca.crt"
      FABRIC_GATEWAY_CERT: "/certs/gateway-client.crt"
      FABRIC_GATEWAY_KEY: "/certs/gateway-client.key"
    volumes:
      - ./gateway/app:/audit-gateway/app
      - ./fabric/network/crypto-material:/certs:ro
      - ./results:/results
    depends_on:
      - minio
    networks:
      - audit_app
      - audit_fabric
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  minio:
    image: minio/minio:latest
    container_name: audit-minio
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - minio-data:/data
    networks:
      - audit_app
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5

  minio-init:
    image: minio/mc:latest
    container_name: audit-minio-init
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
        mc alias set local http://minio:9000 minioadmin minioadmin;
        mc mb --ignore-existing local/audit-evidence;
        mc anonymous set download local/audit-evidence;
        echo 'MinIO bucket ready: audit-evidence';
      "
    networks:
      - audit_app
    restart: "no"
